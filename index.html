<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>THREE.js EAC test</title>
    <style>
        body {
            background-color: #ccc;
            color: #000;
            margin: 0;
        }

        a {
            color: #f00;
        }
        #video {
            display: none;
        }
    </style>
</head>
<body>

<div id="viz"></div>
<video id="video" loop muted crossOrigin="anonymous" playsInline style= }}>
    <source src="/lions.webm" />
</video>


<script type="module">

  import * as THREE from './three.module.js';
  import { VRButton } from './vrButton.js';
  let camera, controls, scene, renderer;
  const SEGMENTS = 9;
  const CUBE_WIDTH = 500;

  camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 0.1, 100 );
  camera.layers.enable( 1 ); // render left view when no stereo available

  init();
  animate();

  function init() {

    const container = document.getElementById('viz');
    const video = document.getElementById('video');

    camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, CUBE_WIDTH * 2 );
    camera.layers.enable( 1 ); // render left view when no stereo available

    video.play();

    const texture = new THREE.VideoTexture( video );

    scene = new THREE.Scene();
    scene.background = new THREE.Color( 0x101010 );

    const geometry1 = new THREE.BoxGeometry(1, 1, 1, SEGMENTS, SEGMENTS, SEGMENTS);
    // invert the geometry on the x-axis so that all of the faces point inward
    geometry1.scale( - CUBE_WIDTH, CUBE_WIDTH, CUBE_WIDTH );

    const uvs1 = geometry1.attributes.uv.array;

    setNewUvsArray(uvs1);

    const material1 = new THREE.MeshBasicMaterial( { map: texture } );

    const mesh1 = new THREE.Mesh( geometry1, material1 );
    // mesh1.position.y = CUBE_WIDTH / 2;
    mesh1.rotateY(-Math.PI/2);
    scene.add( mesh1 );
    // camera.add(mesh1);

    renderer = new THREE.WebGLRenderer();
    renderer.setPixelRatio( window.devicePixelRatio );
    renderer.setSize( window.innerWidth, window.innerHeight );
    renderer.xr.enabled = true;
    renderer.xr.setReferenceSpaceType( 'local' );
    container.appendChild( renderer.domElement );

    document.body.appendChild( VRButton.createButton( renderer ) );

    window.addEventListener( 'resize', onWindowResize );

  }

  function animate() {

    renderer.setAnimationLoop( renderScene );

  }

  function renderScene() {

    renderer.render( scene, camera );

  }

  function onWindowResize() {

    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    renderer.setSize( window.innerWidth, window.innerHeight );

  }

  function getFaceUvTransformation(faceIndex, u, v) {
    switch(faceIndex) {
      case 0:
        return [
          2/3 - u * (1/3),
          1/2 + v * (1/2),
        ];
      case 1:
        return [
          1/3 + v * (1/3),
          u * (1/2),
        ];
      case 2:
        return [
          1 - u * (1/3),
          v * (1/2)
        ];
      case 3:
        return [
          u * (1/3),
          1/2 - v * (1/2)
        ];
      case 4:
        return [
          1 / 3 - u * (1/3),
          1/2 + v * (1/2)
        ];
      case 5:
        return [
          1 - u * (1/3) - Number.EPSILON,
          1/2 + v * (1/2) - Number.EPSILON
        ];
      default:
        return [
          u,
          v
        ];
    }
  }

  function setNewUvsArray(uvs) {
    // Loop over faces
    for(let faceIndex = 0; faceIndex < 6; faceIndex++) {
      const offset = faceIndex * (Math.pow(SEGMENTS + 1, 2));

      // Loop over rows
      for(let k = 0; k < SEGMENTS + 1; k++) {

        // Loop over columns in each row
        for(let i = 0; i < SEGMENTS + 1; i++) {
          const index = offset + k * (SEGMENTS + 1) + i;
          const [x, y] = [1/2 - i/(SEGMENTS), 1/2 - k/(SEGMENTS)];
          const [u, v] = [
            1/2 + (2/Math.PI) * Math.atan(2*x),
            1/2 + (2/Math.PI) * Math.atan(2*y)
          ];

          const [imagex, imagey] = getFaceUvTransformation(faceIndex, u, v)
          uvs[index*2] = imagex;
          uvs[index * 2 + 1] = imagey;
        }
      }
    }
  }
</script>


</body>
</html>
